#!/usr/bin/python3
import sys
import PIL.Image

if len(sys.argv) < 2:
	exit("usage: %s imagefile [palette]" % sys.argv[0])
if len(sys.argv) > 2:
	pal = int(sys.argv[2])
else:
	pal = 0

img = PIL.Image.open(sys.argv[1])
img = img.convert("P", dither=0, palette=1, colors=4)
img = img.resize((160, 128))

pixels = img.load()
width, height = 160, 128

lch = []
lch.append(0)

lbg = []
lbg.append(0)
lbg.append(0)
lbg.append(20)
lbg.append(16)

for sy in range(0, height, 8):
	for sx in range(0, width, 8):
		c1 = c2 = c3 = c4 = 0
		for y in range(8):
			for x in range(8):
				p1 = pixels[7 - x + sx, 7 - y + sy]
				p2 = pixels[    x + sx, 7 - y + sy]
				p3 = pixels[7 - x + sx,     y + sy]
				p4 = pixels[    x + sx,     y + sy]
				c1 |= ((p1 & 1) << x + 64 | (p1 >> 1 & 1) << x) << y * 8
				c2 |= ((p2 & 1) << x + 64 | (p2 >> 1 & 1) << x) << y * 8
				c3 |= ((p3 & 1) << x + 64 | (p3 >> 1 & 1) << x) << y * 8
				c4 |= ((p4 & 1) << x + 64 | (p4 >> 1 & 1) << x) << y * 8
		if c1 in lch:
			lbg.append(lch.index(c1))
			lbg.append(pal | 0x00)
		elif c2 in lch:
			lbg.append(lch.index(c2))
			lbg.append(pal | 0x08)
		elif c3 in lch:
			lbg.append(lch.index(c3))
			lbg.append(pal | 0x10)
		elif c4 in lch:
			lbg.append(lch.index(c4))
			lbg.append(pal | 0x18)
		else:
			lbg.append(len(lch))
			lbg.append(pal | 0x00)
			lch.append(c1)

sys.stdout.write("#2:CHR\n")
for c in lch:
	sys.stdout.write("%032X" % c)
sys.stdout.write("\n")

sys.stdout.write("#3:BG\n")
for b in lbg:
	sys.stdout.write("%02X" % b)
sys.stdout.write("\n")
